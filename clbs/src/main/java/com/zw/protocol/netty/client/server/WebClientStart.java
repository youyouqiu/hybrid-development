package com.zw.protocol.netty.client.server;

import com.zw.platform.basic.constant.HistoryRedisKeyEnum;
import com.zw.platform.basic.core.RedisHelper;
import com.zw.platform.basic.core.RedisKey;
import com.zw.platform.push.controller.UserCache;
import com.zw.platform.push.controller.UserCacheA;
import com.zw.platform.push.controller.UserCacheS;
import com.zw.protocol.netty.ServerStart;
import com.zw.protocol.netty.client.coder.factory.WebClientHandler;
import com.zw.protocol.netty.client.coder.factory.WebDecoder;
import com.zw.protocol.netty.client.coder.factory.WebEncoder;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.socket.SocketChannel;
import io.netty.handler.timeout.IdleStateHandler;
import io.netty.util.concurrent.DefaultEventExecutorGroup;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import java.util.concurrent.TimeUnit;

public class WebClientStart extends ServerStart {
    private static final Logger logger = LogManager.getLogger(WebClientStart.class);

    private ClientToAccessServer executor;
    private DefaultEventExecutorGroup eventExecutorGroup;

    @Override
    public void run() {
        UserCache.getInstance();
        UserCacheA.getInstance();
        UserCacheS.getInstance();
        initDefaultAlarmPush();

        eventExecutorGroup = new DefaultEventExecutorGroup(16);
        executor = new ClientToAccessServer();
        ChannelInitializer<SocketChannel> channelInitializer = new ChannelInitializer<SocketChannel>() {
            public void initChannel(SocketChannel channel) {
                channel.pipeline()
                    .addLast(new IdleStateHandler(0, 0, 3 * 60L, TimeUnit.SECONDS))
                    // .addLast(new LengthFieldBasedFrameDecoder(Integer.MAX_VALUE, 0, 4, 0, 4))
                    .addLast(new WebDecoder())
                    .addLast(new WebEncoder())
                    .addLast(eventExecutorGroup, new WebClientHandler(executor, messageHandler).setClientId(clientId));
            }
        };
        try {
            executor.start(applicationEntity, channelInitializer);
        } catch (Exception e) {
            logger.error("WebClientStart异常", e);
        }
    }

    @Override
    public void close() {
        if (executor == null) {
            return;
        }
        executor.close();
        eventExecutorGroup.shutdownGracefully();
    }

    private void initDefaultAlarmPush() {
        RedisKey defaultPushRedisKey = HistoryRedisKeyEnum.DEFAULT_PUSH.of();
        if (RedisHelper.isContainsKey(defaultPushRedisKey)) {
            RedisHelper.delete(defaultPushRedisKey);
        }
        RedisHelper.setString(defaultPushRedisKey, getDefaultAlarmPush());
        //音视频报警默认推送缓存存储
        String defaultVideoPush = "{\"defaultVideo_push\":{\"12517\": [1],\"12638\": [1],\"12715\": [1],\"12518\": [1],"
            + "\"12716\": [1],\"12515\": [1],\"12636\": [1],\"12713\": [1],\"12516\": [1],"
            + "\"12637\": [1],\"12714\": [1],\"12719\": [1],\"12519\": [1],\"12717\": [1],"
            + "\"12718\": [1],\"12630\": [1],\"12631\": [1],\"12513\": [1],\"12634\": [1],"
            + "\"12711\": [1],\"12514\": [1],\"12635\": [1],\"12712\": [1],\"12511\": [1],"
            + "\"12632\": [1],\"12512\": [1],\"12633\": [1],\"13011\": [1],\"13012\": [1],"
            + "\"12528\": [1],\"12726\": [1],\"12529\": [1],\"12526\": [1],\"12724\": [1],"
            + "\"12527\": [1],\"12725\": [1],\"128\": [1],\"12520\": [1],\"12641\": [1],"
            + "\"129\": [1],\"12521\": [1],\"12642\": [1],\"13013\": [1],\"12640\": [1],"
            + "\"12524\": [1],\"12722\": [1],\"12525\": [1],\"12723\": [1],\"12522\": [1],"
            + "\"12720\": [1],\"12523\": [1],\"12721\": [1],\"131\": [1],\"12539\": [1],"
            + "\"12616\": [1],\"12617\": [1],\"12537\": [1],\"12614\": [1],\"12538\": [1],"
            + "\"12615\": [1],\"12618\": [1],\"12619\": [1],\"12531\": [1],\"12532\": [1],"
            + "\"12530\": [1],\"12535\": [1],\"12612\": [1],\"12536\": [1],\"12613\": [1],"
            + "\"12533\": [1],\"12534\": [1],\"12611\": [1],\"12627\": [1],\"12628\": [1],"
            + "\"12625\": [1],\"12626\": [1],\"12629\": [1],\"12542\": [1],\"12620\": [1],"
            + "\"12540\": [1],\"12541\": [1],\"12623\": [1],\"12624\": [1],\"12621\": [1],"
            + "\"12622\": [1],\"12639\": [1]}}";
        RedisKey defaultVideoPushRedisKey = HistoryRedisKeyEnum.DEFAULT_VIDEO_PUSH.of();
        if (RedisHelper.isContainsKey(defaultVideoPushRedisKey)) {
            RedisHelper.delete(defaultVideoPushRedisKey);
        }
        RedisHelper.setString(defaultVideoPushRedisKey, defaultVideoPush);
        RedisHelper.setString(HistoryRedisKeyEnum.ICON_DIRECTION.of(), "false");
    }

    private static String getDefaultAlarmPush() {
        return "{\"default_push\":{\"6551\":[1],\"6552\":[1],\"6511\":[1],\"6632\":[1],\"6631\":[1],"
            + "\"2111\":[1],\"6821\":[1],\"6622\":[1],\"6822\":[1],\"7211\":[1],\"6641\":[1],"
            + "\"7212\":[1],\"6522\":[1],\"6521\":[1],\"6642\":[1],\"0\":[1],\"1\":[1],\"2\":[1],"
            + "\"124\":[1],\"2112\":[1],\"6512\":[1],\"20\":[1],\"21\":[1],\"23\":[1],\"67\":[1],"
            + "\"69\":[1],\"6531\":[1],\"27\":[1],\"6532\":[1],\"2012\":[1],\"2011\":[1],\"70\":[1],"
            + "\"75\":[1],\"76\":[1],\"77\":[1],\"7112\":[1],\"7111\":[1],\"6542\":[1],"
            + "\"7312\":[1],\"6541\":[1],\"7113\":[1],\"7311\":[1],\"6621\":[1],"
            + "\"6612\":[1],\"6611\":[1],\"6812\":[1],\"6811\":[1],\"104\":[1],"
            + "\"106\":[1],\"107\":[1],\"105\":[1],\"108\":[1],\"109\":[1],\"123\":[1],\"1111\":[1],"
            + "\"1112\":[1],\"113\":[1],\"114\":[1],\"32\":[1],\"11511\":[1],\"11512\":[1],"
            + "\"11611\":[1],\"11612\":[1],\"118\":[1],\"81\":[1],\"80\":[1],\"147\":[1],"
            + "\"79\":[1],\"6513\":[1],\"6523\":[1],\"6533\":[1],\"6543\":[1],\"6553\":[1],"
            + "\"6613\":[1],\"6623\":[1],\"6633\":[1],\"6643\":[1],\"6653\":[1],\"6651\":[1],"
            + "\"6652\":[1],\"6813\":[1],\"6823\":[1],\"6833\":[1],\"6843\":[1],\"6831\":[1],"
            + "\"6832\":[1],\"6841\":[1],\"6842\":[1],\"12411\":[1],\"14411\":[1],\"13213\":[1],"
            + "\"13214\":[1],\"7011\":[1],\"7021\":[1],\"7012\":[1],\"7022\":[1],"
            + "\"14399\":[1],\"14300\":[1],\"14301\":[1],\"14302\":[1],\"14303\":[1],\"14304\":[1],"
            + "\"14305\":[1],\"14306\":[1],\"14310\":[1],\"14311\":[1],\"14312\":[1],\"14313\":[1],"
            + "\"14314\":[1],\"14315\":[1],\"14316\":[1],\"14320\":[1],\"14321\":[1],\"14322\":[1],"
            + "\"14323\":[1],\"14324\":[1],\"14325\":[1],\"14326\":[1],\"14330\":[1],\"14331\":[1],"
            + "\"14332\":[1],\"14333\":[1],\"14334\":[1],\"14335\":[1],\"14336\":[1],\"14340\":[1],"
            + "\"14341\":[1],\"14342\":[1],\"14343\":[1],\"14344\":[1],\"14345\":[1],\"14346\":[1],"
            + "\"14350\":[1],\"14351\":[1],\"14352\":[1],\"14353\":[1],\"14354\":[1],\"14355\":[1],"
            + "\"14356\":[1],\"14360\":[1],\"14361\":[1],\"14362\":[1],\"14363\":[1],\"14364\":[1],"
            + "\"14365\":[1],\"14366\":[1],\"14370\":[1],\"14371\":[1],\"14372\":[1],\"14373\":[1],"
            + "\"14374\":[1],\"14375\":[1],\"14376\":[1],\"14380\":[1],\"14381\":[1],\"14382\":[1],"
            + "\"14383\":[1],\"14384\":[1],\"14385\":[1],\"14386\":[1],\"14390\":[1],\"14391\":[1],"
            + "\"14392\":[1],\"14393\":[1],\"14394\":[1],\"14395\":[1],\"14396\":[1],\"14310\":[1],"
            + "\"143101\":[1],\"143102\":[1],\"143103\":[1],\"143104\":[1],\"143105\":[1],\"143106\":[1],"
            + "\"143110\":[1],\"143111\":[1],\"143112\":[1],\"143113\":[1],\"143114\":[1],\"143115\":[1],"
            + "\"143116\":[1],\"143120\":[1],\"143121\":[1],\"143122\":[1],\"143123\":[1],\"143124\":[1],"
            + "\"143125\":[1],\"143126\":[1],\"143130\":[1],\"143131\":[1],\"143132\":[1],\"143133\":[1],"
            + "\"143134\":[1],\"143135\":[1],\"143136\":[1],\"143140\":[1],\"143141\":[1],\"143142\":[1],"
            + "\"143143\":[1],\"143144\":[1],\"143145\":[1],\"143146\":[1],\"143150\":[1],\"143151\":[1],"
            + "\"143152\":[1],\"143153\":[1],\"143154\":[1],\"143155\":[1],\"143156\":[1],\"143160\":[1],"
            + "\"143161\":[1],\"143162\":[1],\"143163\":[1],\"143164\":[1],\"143165\":[1],\"143166\":[1],"
            + "\"143170\":[1],\"143171\":[1],\"143172\":[1],\"143173\":[1],\"143174\":[1],\"143175\":[1],"
            + "\"143176\":[1],\"143180\":[1],\"143181\":[1],\"143182\":[1],\"143183\":[1],\"143184\":[1],"
            + "\"143185\":[1],\"143186\":[1],\"143190\":[1],\"143191\":[1],\"143192\":[1],\"143193\":[1],"
            + "\"143194\":[1],\"143195\":[1],\"143196\":[1],"
            + "\"15\":[1],\"16\":[1],\"17\":[1],\"148\":[1],\"149\":[1],\"150\":[1],\"151\":[1],"
            + "\"18710\":[1],\"18711\":[1],\"18712\":[1],\"18713\":[1],\"18714\":[1],\"18715\":[1],\"18716\":[1],"
            + "\"18717\":[1],\"18719\":[1],\"11911\":[1],\"11912\":[1],\"152\":[2],\"153\":[2],\"154\":[2],"
            + "\"155\":[2],\"156\":[2],\"19711\":[2],\"203\":[1],\"164\":[1],\"143100\":[1],\"18810\":[1],"
            + "\"18811\":[1],\"18812\":[1],\"18813\":[1],\"18814\":[1],\"18815\":[1],\"7702\":[1],\"7703\":[1]}}";
    }

}
