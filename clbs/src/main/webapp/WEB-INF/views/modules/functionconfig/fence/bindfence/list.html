<!DOCTYPE html>
<html class="no-js" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>围栏绑定</title>
    <div th:replace="fragments/header">header</div>
    <link rel="stylesheet" href="/resources/css/electronicFence.css" th:src="@{/resources/css/electronicFence.css}">
</head>
<body>
<section id="container">
    <div th:replace="fragments/nav">nav</div>
    <div th:replace="fragments/menu">menu</div>
    <!--main content start-->
    <section class="main-content-wrapper">
        <section id="main-content">
            <div class="row">
                <div class="col-md-12">
                    <ul class="breadcrumb">
                        <li><a th:href="@{/}">首页</a></li>
                        <li class="active">应用管理</li>
                        <li class="active">电子围栏</li>
                        <li class="active">围栏绑定</li>
                    </ul>
                    <h1 class="h1 ">围栏绑定</h1>
                </div>
            </div>
            <div class="row" id="mapContainerBox">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title fwb">地图预览</h3>
                            <div class="actions pull-right">
                                <i id="fenceMap" class="fa fa-chevron-up mapBind"></i>
                            </div>
                        </div>
                        <div id="fenceMapArea" class="panel-body mapContainer" style="display:none;">
                            <div id="mapContainer" class="mapArea"></div>
                            <div id="map-button" class="button-group">
                                <input type="button" class="button" value="卫星" id="setMap"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" id="mapContainerCarBox">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title fwb">地图预览</h3>
                            <div class="actions pull-right">
                                <i id="charMap" class="fa fa-chevron-up mapBind"></i>
                            </div>
                        </div>
                        <div id="charMapArea" class="panel-body mapContainer" style="display:none;">
                            <div id="mapContainerCar" class="mapArea"></div>
                            <div id="map-buttonCar" class="button-group">
                                <input type="button" class="button" value="卫星" id="setMapCar"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="dropdown panel-title fwb">
                                <ul class="nav nav-tabs">
                                    <li class="active" id="TabFenceBox"><a href="#home1" data-toggle="tab">按围栏</a></li>
                                    <li id="TabCarBox"><a href="#profile1" data-toggle="tab">按监控对象</a></li>
                                </ul>
                            </div>

                            <div class="actions pull-right">
                                <i class="fa fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="panel-body">
                            <div class="tab-content">
                                <div class="tab-pane active" id="home1">
                                    <section class="fuelux">
                                        <form class="form-horizontal">
                                            <div id="fenceAll" class="col-md-2">
                                                <h5 class="fwb">围栏列表</h5>
												<div class="form-group" style="margin-bottom:0;">
													<div class="col-md-11" style="padding-right: 0">
														<input id = "searchFence" name= "search" class="form-control" style="margin-bottom:10px;" type="text" placeholder="请输入关键字" />
													</div>
												</div>
                                                <div class="treeArea">
                                                    <ul id="fenceDemo" name="fenceTree" class="ztree"></ul>
                                                </div>
                                            </div>
                                            <div id="charAll" class="col-md-2">
                                                <h5 class="fwb">监控对象列表</h5>
                                                <div class="form-group" style="margin-bottom:0;">
                                                	<div class="col-md-11" style="padding-right: 0">
                                                		<input id = "searchVehicle" name= "search" class="form-control" style="margin-bottom:10px;" type="text" placeholder="请输入关键字" />
                                                	</div>
                                                </div>
                                                <div class="treeArea">
                                                    <ul id="treeDemo" class="ztree"></ul>
                                                </div>
                                            </div>
                                            <div class="col-md-1 addAreaFance">
                                                <div class="add-button" id="addBtn">
                                                        <span class="glyphicon glyphicon-chevron-right add-left"
                                                              aria-hidden="true"></span>
                                                </div>
                                                <div class="add-button" id="removeBtn">
                                                        <span class="glyphicon glyphicon-chevron-left add-right"
                                                              aria-hidden="true"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-7" id="tableArea">
                                            	<h5 class="fwb fenceTc">绑定详情</h5>
                                            	<div class="form-group" style="margin-bottom:0;">
                                                    <div class="col-sm-11 col-md-12 control-label" style="padding-top:0;padding-bottom:6px;">
                                                        <button type="button" id="setAll"
                                                                class="btn btn-primary nextBtn"
                                                                data-dismiss="modal">依例全设
                                                        </button>
                                                        <button th:if="${hasRole}" id="fenceSaveBtn" type="button"
                                                                class="btn btn-primary nextBtn"
                                                                data-dismiss="modal">&nbsp;保存&nbsp;</button>
                                                    </div>
                                                </div>
                                                <div id="bindTableByFence" class="bindFence">
                                                    <table id="tableList" name="fenceTable"
                                                           class="table table-striped table-bordered table-hover"
                                                           cellspacing="0">
                                                        <thead>
                                                        <tr>
                                                            <th style="background: none;"><input
                                                                    type="checkbox" id="checkAll" class="checkAll"/>
                                                            </th>
                                                            <th>围栏名称</th>
                                                            <th>监控对象</th>
                                                            <th>围栏类型</th>
                                                            <th>下发类型</th>
                                                            <th>驶入报警给平台</th>
                                                            <th>驶出报警给平台</th>
                                                            <th>开始日期</th>
                                                            <th>结束日期</th>
                                                            <th>开始时间</th>
                                                            <th>结束时间</th>
                                                            <th>最高速度(km/h)</th>
                                                            <th>超速持续时间(s)</th>
                                                            <th class="hidden">围栏id</th>
                                                            <th class="hidden">车id</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </form>
                                    </section>
                                </div>
                                <div class="tab-pane" id="profile1">
                                    <section class="fuelux">
                                        <form class="form-horizontal">
                                            <div id="charAllCar" class="col-md-2">
                                                <h5 class="fwb">监控对象列表</h5>
                                                <div class="form-group" style="margin-bottom:0;">
                                                	<div class="col-md-11" style="padding-right: 0">
                                                		<input id="searchVehicleCar" name= "search" class="form-control" style="margin-bottom:10px;" type="text" placeholder="请输入关键字" />
                                                	</div>
                                                </div>
                                                <div class="treeArea">
                                                    <ul id="treeDemoCar" class="ztree"></ul>
                                                </div>
                                            </div>
                                            <div id="fenceAllCar" class="col-md-2">
                                                <h5 class="fwb">围栏列表</h5>
                                                <div class="form-group" style="margin-bottom:0;">
                                                	<div class="col-md-11" style="padding-right: 0">
                                                		<input id = "searchFenceCar" name= "search" class="form-control" style="margin-bottom:10px;" type="text" placeholder="请输入关键字" />
                                                	</div>
                                                </div>
                                                <div class="treeArea">
                                                    <ul id="fenceDemoCar" class="ztree"></ul>
                                                </div>
                                            </div>
                                            <div class="col-md-1 addAreaFance">
                                                <div class="add-button" id="addBtnCar">
                                                        <span class="glyphicon glyphicon-chevron-right add-left"
                                                              aria-hidden="true"></span>
                                                </div>
                                                <div class="add-button" id="removeBtnCar">
                                                        <span class="glyphicon glyphicon-chevron-left add-right"
                                                              aria-hidden="true"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-7">
                                                <h5 class="fwb fenceTc">绑定详情</h5>
                                                <div class="form-group" style="margin-bottom:0;">
                                                    <div class="col-sm-11 col-md-12 control-label" style="padding-top:0;padding-bottom:6px;">
                                                        <button type="button" id="setAllCar"
                                                                class="btn btn-primary nextBtn"
                                                                data-dismiss="modal">依例全设
                                                        </button>
                                                        <button th:if="${hasRole}" id="carSaveBtn" type="button"
                                                                class="btn btn-primary nextBtn"
                                                                data-dismiss="modal">&nbsp;保存&nbsp;</button>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div id="bindTableByCar" class="bindCar">
                                                        <table id="tableListCar" name="fenceTable"
                                                               class="table table-striped table-bordered table-hover"
                                                               cellspacing="0">
                                                            <thead>
                                                            <tr>
                                                                <th style="background: none;"><input
                                                                        type="checkbox" id="checkCarAll"/></th>
                                                                <th>围栏名称</th>
                                                                <th>监控对象</th>
                                                                <th>围栏类型</th>
                                                                <th>下发类型</th>
                                                                <th>驶入报警给平台</th>
                                                                <th>驶出报警给平台</th>
                                                                <th>开始日期</th>
                                                                <th>结束日期</th>
                                                                <th>开始时间</th>
                                                            	<th>结束时间</th>
                                                            	<th>最高速度(km/h)</th>
                                                            	<th>超速持续时间(s)</th>
                                                                <th class="hidden">围栏id</th>
                                                                <th class="hidden">车id</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>

                                                            </tbody>

                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </section>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title fwb">绑定列表</h3>
                            <div class="actions pull-right">
                                <i class="fa fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="panel-body fixed-table-body">
                            <div class="ToolPanel">
                                <div class="bars pull-left">
                                    <div class="btn-group pull-left barsMargin" role="group">
                                        <form role="form">
                                            <label><input type="text" class="Inlinesearch form-control"
                                                          id="simpleQueryParam" name="simpleQueryParam" style="width:300px"
                                                          placeholder="请输入监控对象/围栏 关键字"></label>
                                            <button id="search_button"  type="button" onclick="myTable.filter()"
                                                    class="btn btn-outline btn-default">搜索
                                            </button>
                                            <input id="hiddenText" type="text" style="display:none" />
                                        </form>
                                    </div>
                                    <div th:if="${hasRole}" class="dropdown pull-left">
                                        <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1"
                                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                            操作菜单<span class="caret"></span>
                                        </button>
		                                <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
		                                     <li><a href="javascript:void(0);" id="send_model"><i class="glyphicon glyphicon-circle-arrow-down icoPaddingLeft"></i>批量下发</a></li>
		                                    <li><a href="javascript:void(0);" id="del_model"><i class="glyphicon glyphicon-trash icoPaddingLeft"></i>批量解除</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="columns btn-group pull-right fenceBinding">
                                    <button id="refreshTable" class="btn btn-default" type="button" name="refresh" title="刷新">
                                        <i class="glyphicon glyphicon-refresh icon-refresh"></i>
                                    </button>
                                    <div class="keep-open btn-group" title="定制显示列">
                                        <button id="customizeColumns" type="button" class="btn btn-default dropdown-toggle"
                                                data-toggle="dropdown">
                                            <i class="glyphicon glyphicon-th icon-th"></i> <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu" role="menu" id="Ul-menu-text">
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <table id="dataTable"
                                   class="table table-striped table-bordered table-hover"
                                   cellspacing="0" width="100%">
                                <thead>
                                <tr>
                                    <th style=" width:1px; padding:0"></th>
                                    <th style="width:30px; padding:8px"><input type="checkbox" id="tableCheckAll"></th>
                                    <th>操作设置</th>
                                    <th>围栏类型</th>
                                    <th>下发类型</th>
                                    <th>围栏名称</th>
                                    <th>监控对象</th>
                                    <th>下发状态</th>
                                    <th>驶入报警给平台</th>
                                    <th>驶出报警给平台</th>
                                    <th>开始日期</th>
                                    <th>结束日期</th>
                                    <th>开始时间</th>
                                 	<th>结束时间</th>
                                 	<th>最高速度(km/h)</th>
                                 	<th>超速持续时间(s)</th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </section>
    <!--main content end-->
	<div th:replace="fragments/footer">footer</div>
</section>
<label id="error_label" class='error' style='display: none;'></label>
</body>
<!-- map JS-->
<script src="https://cache.amap.com/lbs/static/es5.min.js"></script>
<script src="https://webapi.amap.com/maps?v=1.3&key=7ffa51dee9ad4a1f313948f82c004904"></script>
<script src="resources/js/zTree/js/ztreeSearch.js" th:src="@{/resources/js/zTree/js/ztreeSearch.js}"></script>
<script src="resources/js/webSocket.js" th:src="@{/resources/js/webSocket.js}"></script>
<script src="resources/js/ungzip/pako.min.js" th:src="@{/resources/js/ungzip/pako.min.js}"></script>
<script src="resources/js/ungzip/ungzip.js" th:src="@{/resources/js/ungzip/ungzip.js}"></script>
<script th:inline="javascript">
(function(window,$){

	var hourseSelect, minuteSelect, secondSelect, time, id;
	var isMapThreeDFlag = true;
	var isMapThreeDFlagCar = true;
	var sendflag=true;
    var trid = [];  // 已勾选的数据（按围栏）
    var tridCar = [];  // 已勾选的数据（按车）
    var menu_text = "";
    var table = $("#dataTable tr th:gt(1)");
    // 围栏数据
    var polyFence,clickStateFence,fenceFlag = true,clickStateChar,charFlag = true,fenceTree,vehicelTree,fenceNode,vehicleNode,Carbox,params = [];
    //地图相关
    var map,buildings,mapCar,satellLayer,satellLayerCar;
    //表格
    //var myTable;
    //单选
    var subChk = $("input[name='subChk']");

	fenceBindingList = {

		init: function(){

	        Carbox = $("#mapContainerCarBox").hide();
		    //地图
		    map = new AMap.Map('mapContainer', {
		        resizeEnable: true,
		        zoom: 13,
		        zoomEnable:false
		    });
		  	//实例化3D楼块图层
		    buildings = new AMap.Buildings();
		    // 在map中添加3D楼块图层
		    buildings.setMap(map);
		    map.on("click",function(){
		   	 	if(map.getStatus().zoomEnable){
		   		 	map.setStatus({zoomEnable: false});
		   		}else{
		   			 map.setStatus({zoomEnable: true});
		   	 	}
		    });
		    //地图
		    mapCar  = new AMap.Map('mapContainerCar', {
		        resizeEnable: true,
		        zoom: 13,
		        zoomEnable:false
		    });
		    mapCar.on("click",function(){
		   	 	if(mapCar.getStatus().zoomEnable){
		   			mapCar.setStatus({zoomEnable: false});
		   	 	}else{
		   			mapCar.setStatus({zoomEnable: true});
		   	 	}
		    });
		    mapCar.plugin(["AMap.ToolBar"], function () {
		        mapCar.addControl(new AMap.ToolBar());
		    });
		    //围栏模式切换
		    satellLayer = new AMap.TileLayer.Satellite();
		    satellLayer.setMap(map);
		    satellLayer.hide();
		    //按车模式切换
		    satellLayerCar = new AMap.TileLayer.Satellite();
		    satellLayerCar.setMap(mapCar);
		    satellLayerCar.hide();

			var hmsTime = '<div id="hmsTime" style="text-align:center;background-color:#ffffff;border:1px solid #cccccc;width:200px; display:none;"><div id="hourseSelect"><div style="text-align:center;width:200px;background-color:#6dcff6;color:#ffffff;">时</div><table style="width:200px;border-top:1px solid #cccccc; color:#6dcff6;"><thead></thead><tbody><tr><td>01</td><td>02</td><td>03</td><td>04</td></tr><tr><td>05</td><td>06</td><td>07</td><td>08</td></tr><tr><td>09</td><td>10</td><td>11</td><td>12</td></tr><tr><td>13</td><td>14</td><td>15</td><td>16</td></tr><tr><td>17</td><td>18</td><td>19</td><td>20</td></tr><tr><td>21</td><td>22</td><td>23</td><td>00</td></tr></tbody></table></div><div id="minuteSelect" style="display:none;"><div style="text-align:center;width:200px;background-color:#6dcff6;color:#ffffff;">分</div><table style="width:200px;border-top:1px solid #cccccc; color:#6dcff6"><thead></thead><tbody><tr><td>01</td><td>02</td><td>03</td><td>04</td><td>05</td><td>06</td></tr><tr><td>07</td><td>08</td><td>09</td><td>10</td><td>11</td><td>12</td></tr><tr><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td></tr><tr><td>19</td><td>20</td><td>21</td><td>22</td><td>23</td><td>24</td></tr><tr><td>25</td><td>26</td><td>27</td><td>28</td><td>29</td><td>30</td></tr><tr><td>31</td><td>32</td><td>33</td><td>34</td><td>35</td><td>36</td></tr><tr><td>37</td><td>38</td><td>39</td><td>40</td><td>41</td><td>42</td></tr><tr><td>43</td><td>44</td><td>45</td><td>46</td><td>47</td><td>48</td></tr><tr><td>49</td><td>50</td><td>51</td><td>52</td><td>53</td><td>54</td></tr><tr><td>55</td><td>56</td><td>57</td><td>58</td><td>59</td><td>00</td></tr></tbody></table></div><div id="secondSelect" style="display:none;"><div style="text-align:center;width:200px;background-color:#6dcff6;color:#ffffff;">秒</div><table style="width:200px;border-top:1px solid #cccccc;color:#6dcff6;"><thead></thead><tbody><tr><td>01</td><td>02</td><td>03</td><td>04</td><td>05</td><td>06</td></tr><tr><td>07</td><td>08</td><td>09</td><td>10</td><td>11</td><td>12</td></tr><tr><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td></tr><tr><td>19</td><td>20</td><td>21</td><td>22</td><td>23</td><td>24</td></tr><tr><td>25</td><td>26</td><td>27</td><td>28</td><td>29</td><td>30</td></tr><tr><td>31</td><td>32</td><td>33</td><td>34</td><td>35</td><td>36</td></tr><tr><td>37</td><td>38</td><td>39</td><td>40</td><td>41</td><td>42</td></tr><tr><td>43</td><td>44</td><td>45</td><td>46</td><td>47</td><td>48</td></tr><tr><td>49</td><td>50</td><td>51</td><td>52</td><td>53</td><td>54</td></tr><tr><td>55</td><td>56</td><td>57</td><td>58</td><td>59</td><td>00</td></tr></tbody></table></div></div>';
			$("body").append(hmsTime);
			$("#hmsTime tr td").on("mouseover", function() {
				$(this).css({
					"background-color" : "#6dcff6",
					"color" : "#ffffff"
				})
			}).on("mouseout", function() {
				$(this).css({
					"background-color" : "#ffffff",
					"color" : "#6dcff6"
				})
			});

//			webSocket.init('/clbs/vehicle');
			 // 接收到消息
//		      webSocket.subscribe(headers,'/topic/fencestatus', fenceBindingList.updataFenceData,null, null);
			// 请求后台，获取所有订阅的车
			// var url="/clbs/m/basicinfo/monitoring/vehicle/subscribeVehicleList";
		    // json_ajax("POST",url,"json",false,null, fenceBindingList.subscribeVehicleCallback);
		  	//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
		    window.onbeforeunload = function(){
		    	var cancelStrS = {
		    		"desc": {
		    			"MsgId": 40964,
		    			"UserName": $("#userName").text()
		    		},
		    		"data": params
		    	};
		    	webSocket.unsubscribealarm(headers,"/app/vehicle/unsubscribestatus", cancelStrS);
		    }
		  	//显示隐藏列
		    menu_text += "<li><label><input type=\"checkbox\" checked=\"checked\" class=\"toggle-vis\" data-column=\"" + parseInt(2) +"\" disabled />"+ table[0].innerHTML +"</label></li>"
		    for(var i = 1; i < table.length; i++){
		        menu_text += "<li><label><input type=\"checkbox\" checked=\"checked\" class=\"toggle-vis\" data-column=\"" + parseInt(i+2) +"\" />"+ table[i].innerHTML +"</label></li>"
		    };
		    $("#Ul-menu-text").html(menu_text);
	 	  	//IE9
	      	if(navigator.appName=="Microsoft Internet Explorer" && navigator.appVersion.split(";")[1].replace(/[ ]/g,"")=="MSIE9.0") {
	      		var search;
	          	$("#searchFence").bind("focus",function(){
	              	search = setInterval(function(){
	            	  	search_ztree('fenceDemo', 'searchFence','fence');
	              	},500);
	          	}).bind("blur",function(){
	              	clearInterval(search);
	          	});
	      	}
	      	//IE9 end
	      	//IE9
			if(navigator.appName=="Microsoft Internet Explorer" && navigator.appVersion.split(";")[1].replace(/[ ]/g,"")=="MSIE9.0") {
			     var search;
			     $("#searchVehicle").bind("focus",function(){
			         search = setInterval(function(){
			        	 search_ztree('treeDemo', 'searchVehicle','vehicle');
			         },500);
			     }).bind("blur",function(){
			         clearInterval(search);
			     });
			}
			//IE9 end
		  	//IE9
			if(navigator.appName=="Microsoft Internet Explorer" && navigator.appVersion.split(";")[1].replace(/[ ]/g,"")=="MSIE9.0") {
			    var search;
			    $("#searchFenceCar").bind("focus",function(){
			        search = setInterval(function(){
			      	  search_ztree('fenceDemoCar', 'searchFenceCar','fence');
			        },500);
			    }).bind("blur",function(){
			        clearInterval(search);
			    });
			}
			//IE9 end
	  	  	//IE9
	      	if(navigator.appName=="Microsoft Internet Explorer" && navigator.appVersion.split(";")[1].replace(/[ ]/g,"")=="MSIE9.0") {
	          	var search;
	          	$("#searchVehicleCar").bind("focus",function(){
	              	search = setInterval(function(){
	            	  	search_ztree('treeDemoCar', 'searchVehicleCar','vehicle');
	              	},500);
	          	}).bind("blur",function(){
	              	clearInterval(search);
	          	});
	       	}
	       	//IE9 end
	      	//按围栏-车辆
			var setChar = {
			    async: {
			        url: "/clbs/m/functionconfig/fence/bindfence/vehicelTree",
			        type: "post",
			        enable: true,
			        autoParam: ["id"],
			        dataType: "json",
			        otherParam: {"type": "multiple"}
			    },
			    check: {
			        enable: true,
			        chkStyle: "checkbox",
			        chkboxType: {
			            "Y": "s",
			            "N": "s"
			        },
			        radioType: "all"
			    },
			    view: {
			        dblClickExpand: false,
					nameIsHTML: true,
					fontCss: setFontCss_ztree
			    },
			    data: {
			        simpleData: {
			            enable: true
			        }
			    },
			    callback: {
			        beforeClick: fenceBindingList.beforeClickVehicle,
			        onCheck: fenceBindingList.onCheckVehicle
			    }
			};
	        //按围栏-围栏
	        var setFence = {
	            async: {
	                url: "/clbs/m/functionconfig/fence/bindfence/fenceTree",
	                tyoe: "post",
	                enable: true,
	                autoParam: ["id"],
	                // contentType : "application/json",
	                dataType: "json",
	                otherParam: {"type": "single"}
	            },
	            check: {
	                enable: true,
	                chkStyle: "radio",
	                radioType: "all",
	                chkboxType: {
	                    "Y": "s",
	                    "N": "s"
	                }
	            },
	            view: {
	                dblClickExpand: false,
	    			nameIsHTML: true,
	    			fontCss: setFontCss_ztree
	            },
	            data: {
	                simpleData: {
	                    enable: true
	                }
	            },
	            callback: {
	                onClick: fenceBindingList.onClickFence,
	                onCheck: fenceBindingList.onCheckFence
	            }
	        };
	        //按车辆-车辆
	        var charAll = {
                async: {
                    url: "/clbs/m/functionconfig/fence/bindfence/vehicelTree",
                    type: "post",
                    enable: true,
                    autoParam: ["id"],
                    dataType: "json",
                    otherParam: {"type": "single"}
                },
                check: {
                    enable: true,
                    chkStyle: "radio",
                    chkboxType: {
                        "Y": "s",
                        "N": "s"
                    },
                    radioType: "all"
                },
                view: {
                    dblClickExpand: false,
        			nameIsHTML: true,
        			fontCss: setFontCss_ztree
                },
                data: {
                    simpleData: {
                        enable: true
                    }
                },
                callback: {
                    beforeClick: fenceBindingList.beforeClickVehicelChar,
                    onCheck: fenceBindingList.onCheckVehicleChar
                }
            };
	        //按车辆-围栏
	        var fenceAll = {
	            async: {
	                url: "/clbs/m/functionconfig/fence/bindfence/fenceTree",
	                type: "post",
	                enable: true,
	                autoParam: ["id"],
	                dataType: "json",
	                otherParam: {"type": "multiple"}
	            },
	            check: {
	                enable: true,
	                chkStyle: "checkbox",
	                chkboxType: {
	                    "Y": "s",
	                    "N": "s"
	                },
	                radioType: "all"
	            },
	            view: {
	                dblClickExpand: false,
	    			nameIsHTML: true,
	    			fontCss: setFontCss_ztree
	            },
	            data: {
	                simpleData: {
	                    enable: true
	                }
	            },
	            callback: {
	               onClick: fenceBindingList.onClickFenceChar,
	                onCheck: fenceBindingList.onCheckFenceChar
	            }
	        };
	        $.fn.zTree.init($("#treeDemo"), setChar, null);
	        $.fn.zTree.init($("#fenceDemo"), setFence, null);
	        $.fn.zTree.init($("#treeDemoCar"), charAll, null);
	        $.fn.zTree.init($("#fenceDemoCar"), fenceAll, null);
	        // 去重
	        Array.prototype.unique2 = function () {
	            var res = [this[0]];
	            for (var i = 1; i < this.length; i++) {
	                var repeat = false;
	                for (var j = 0; j < res.length; j++) {
	                    if (this[i].id == res[j].id) {
	                        repeat = true;
	                        break;
	                    }
	                }
	                if (!repeat) {
	                    res.push(this[i]);
	                }
	            }
	            return res;
	        }

	        //表格列定义
	        var columnDefs = [{
	            //第一列，用来显示序号
	            "searchable": false,
	            "orderable": false,
	            "targets": 0
	        }];
	        var columns = [
	            {
	                //第一列，用来显示序号
	                "data": null,
	                "class": "text-center"
	            },
	            {
	                "data": null,
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                    var result = '';
	                        var obj = {};
	                        obj.fenceConfigId = row.id;
	                        obj.paramId = row.paramId;
	                        obj.vehicleId = row.vehicle_id;
	                        obj.fenceId=row.fence_id;
	                        var jsonStr = JSON.stringify(obj)
	                        result += "<input  type='checkbox' name='subChk'  value='" + jsonStr + "' />";
	                    return result;
	                }
	            },
	            {
	                "data": null,
	                "class": "text-center", //最后一列，操作按钮
	                render: function (data, type, row, meta) {
	                    var editUrlPath = myTable.editUrl + row.id + ".gsp"; //修改地址
	                    var result = '';
	                    // 围栏下发按钮
	                    if (row.type == 'zw_m_marker') {
	        				result += ' <button disabled onclick="fenceBindingList.sendFenceOne(\''+row.id+'\',\''+row.paramId+'\',\''+row.vehicle_id+'\',\''+row.fence_id+'\')" class="editBtn btn-default" type="button"><i class="glyphicon glyphicon-circle-arrow-down"></i>围栏下发</button>&nbsp;'
	                    }else {
	        				result += ' <button onclick="fenceBindingList.sendFenceOne(\''+row.id+'\',\''+row.paramId+'\',\''+row.vehicle_id+'\',\''+row.fence_id+'\')" class="editBtn editBtn-info" type="button"><i class="glyphicon glyphicon-circle-arrow-down"></i>围栏下发</button>&nbsp;'
	                    }
	                    //删除按钮
	                    result += '<button type="button" onclick="myTable.deleteItem(\''
	                            + row.id
	                            + '\')" class="deleteButton editBtn disableClick"><i class="fa fa-trash-o"></i>解除绑定</button>';
	                    return result;
	                }
	            }, {
	                "data": "type",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                    return fenceBindingList.fencetypepid(data);
	                }
	            }, {
	                "data": "name",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                    var fenceId = '<a onclick="fenceBindingList.tableFence(\'' + row.fenceId + '\')">'+ data +'</a>';
	                    return fenceId;
	                }
	            }, {
	                "data": "brand",
	                "class": "text-center"
	            }, {
	                "data": "dirStatus",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                    if (data == "0") {
	                        return '指令已生效';
	                    } else if (data == "1") {
	                    	return '指令未生效';
	                    } else if (data == "2") {
	                    	return "指令未生效";
	                    } else if (data == "3") {
	                    	return "指令未生效";
	                    } else if (data == "4") {
	                    	return "指令已发出";
	                    } else if  (data == "5") {
	                    	return "设备离线，未下发";
	                    } else {
	                        return "";
	                    }
	                }
	            }, {
	                "data": "send_fence_type",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                    if (data == "0") {
	                        return '更新';
	                    } else if (data == "1") {
	                        return '追加';
	                    } else if (data == "2") {
	                        return "修改";
	                    }
	                }
	            },{
	                "data": "alarm_in",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                    if (data == "1") {
	                        return 'V';
	                    } else if (data == "0") {
	                        return 'X';
	                    } else {
	                        return data;
	                    }
	                }
	            }, {
	                "data": "alarm_out",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                    if (data == 1) {
	                        return 'V';
	                    } else if (data == 0) {
	                        return 'X';
	                    } else {
	                        return data;
	                    }
	                }
	            }, {
	                "data": "alarm_start_time",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                	if (data != null && data != "") {
	                		var dateStr=data.substring(0,10);
	                    	return dateStr;
	                	}else{
	                		return "";
	                	}
	                }
	            }, {
	                "data": "alarm_end_time",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                	if (data != null && data != "") {
	                		var dateStr=data.substring(0,10);
	                    	return dateStr;
	                	}else{
	                		return "";
	                	}
	                }
	            }, {
	                "data": "alarm_start_date",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                	if (data != null && data != "") {
	                		var dateStr=data.substring(10);
	                    	return dateStr;
	                	}else{
	                		return "";
	                	}
	                }
	            }, {
	                "data": "alarm_end_date",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                	if (data != null && data != "") {
	                		var dateStr=data.substring(10);
	                    	return dateStr;
	                	}else{
	                		return "";
	                	}
	                }
	            }, {
	                "data": "speed",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                	return data;
	                }
	            }, {
	                "data": "over_speed_last_time",
	                "class": "text-center",
	                render: function (data, type, row, meta) {
	                	return data;
	                }
	            }];
	        //ajax参数
	        var ajaxDataParamFun = function (d) {
	            d.simpleQueryParam = $('#simpleQueryParam').val(); //模糊查询
	        };
	        //表格setting
	        var setting = {
	            listUrl: /*[[@{/m/functionconfig/fence/bindfence/list}]]*/'url',
	            // editUrl : /*[[@{/m/basicinfo/equipment/device/edit_}]]*/'url',
	            deleteUrl: /*[[@{/m/functionconfig/fence/bindfence/delete_}]]*/'url',
	            deletemoreUrl: /*[[@{/m/functionconfig/fence/bindfence/deletemore}]]*/'url',
	            enableUrl: /*[[@{/c/user/enable_}]]*/'url',
	            disableUrl: /*[[@{/c/user/disable_}]]*/'url',
	            columnDefs: columnDefs, //表格列定义
	            columns: columns, //表格列
	            dataTableDiv: 'dataTable', //表格
	            ajaxDataParamFun: ajaxDataParamFun, //ajax参数
	            pageable: true, //是否分页
	            showIndexColumn: true, //是否显示第一列的索引列
	            enabledChange: true
	        };
	        //创建表格
	        myTable = new TG_Tabel.createNew(setting);
	        //表格初始化
	        myTable.init();

		  	//----------------------------------

		},
		hourseSelectClick: function(){
			hourseSelect = $(this).text();
			$("#hourseSelect").hide();
			$("#minuteSelect").show();
		},
		minuteSelectClick: function(){
			minuteSelect = $(this).text();
			$("#minuteSelect").hide();
			$("#secondSelect").show();
		},
		secondSelectClick: function(){
			secondSelect = $(this).text();
			$("#secondSelect").hide();
			$("#hourseSelect").show();
			$("#hmsTime").hide();
			time = hourseSelect + ":" + minuteSelect + ":" + secondSelect;
			$("#" + id).val(time);
		},
		laydateTime: function(e){
		    id = e.id;
			var offset = $("#" + id).offset();
			var height = $("#" + id).height();
			$("#hmsTime").show().css({
				"position":"absolute",
				"top":offset.top + height + 10 + "px",
				"left":offset.left + "px"
			});
		},
		bodyClickEvent: function(event){
			if ($(event.target).parents("#hmsTime").length == 0 && event.target.id != "hmsTime" && event.target.id != id) {
		        $("#hmsTime").hide();
		    }
		},
	/* 	// 返回方法
		subscribeVehicleCallback: function(data){
			if (data != null && data.length >0){
		    	  for (var i=1; i<data.length; i++) {
		    		  var obj = new Object();
			          obj.vehicleID = data[i].id;
			          params.push(obj)
		    	  }
		      }
		      //订阅所有车辆
		      var requestStrS = {
		           "desc": {
		               "MsgId": 40964,
		               "UserName": $("#userName").text()
		           },
		           "data": params
		      };
		      // 接收到消息
		      webSocket.subscribe(headers,'/topic/fencestatus', fenceBindingList.updataFenceData,null, null);
		 }, */
		 updataFenceData: function(msg){
		  	if (msg != null) {
		   		var result = $.parseJSON(msg.body);
		  		if (result != null) {
		 			myTable.refresh();
		  		}
		  	}
		 },
		 //地图初始隐藏
		 mapBindClick: function(){
		 	if($(this).hasClass("fa-chevron-up")){
		 		$(this).attr("class","fa fa-chevron-down mapBind");
		 		$(this).parent().parent().siblings().css("display","block");
		 	}else{
		 		$(this).attr("class","fa fa-chevron-up mapBind");
		 		$(this).parent().parent().siblings().css("display","none");
		 	}
		 },
		 //标注
	     drawMark: function(mark, thisMap){
	        var dataArr = [];
	        dataArr.push(mark.longitude);
	        dataArr.push(mark.latitude);
	        polyFence = new AMap.Marker({
	            position: dataArr
	        });
	        polyFence.setMap(thisMap);
	        thisMap.setFitView(polyFence);
	     },
	   	 //线
	     drawLine: function(line, thisMap){
	         var dataArr = new Array();
	         if (line != null && line.length > 0) {
	             for (var i in line) {
	                 dataArr[i] = [line[i].longitude, line[i].latitude];
	             }
	         }
	         polyFence = new AMap.Polyline({
	             path: dataArr, //设置线覆盖物路径
	             strokeColor: "#3366FF", //线颜色
	             strokeOpacity: 1, //线透明度
	             strokeWeight: 5, //线宽
	             strokeStyle: "solid", //线样式
	             strokeDasharray: [10, 5]
	             //补充线样式
	         });
	         polyFence.setMap(thisMap);
	         thisMap.setFitView(polyFence);
	     },
	     //矩形
	     drawRectangle: function(rectangle, thisMap){
	         var dataArr = new Array();
	         if (rectangle != null) {
	             dataArr.push([rectangle.leftLongitude, rectangle.leftLatitude]); // 左上角
	             dataArr.push([rectangle.rightLongitude, rectangle.leftLatitude]); // 右上角
	             dataArr.push([rectangle.rightLongitude, rectangle.rightLatitude]); // 右下角
	             dataArr.push([rectangle.leftLongitude, rectangle.rightLatitude]); // 左下角
	         }
	         polyFence = new AMap.Polygon({
	             path: dataArr,//设置多边形边界路径
	             strokeColor: "#FF33FF", //线颜色
	             strokeOpacity: 0.2, //线透明度
	             strokeWeight: 3, //线宽
	             fillColor: "#1791fc", //填充色
	             fillOpacity: 0.35
	             //填充透明度
	         });
	         polyFence.setMap(thisMap);
	         thisMap.setFitView(polyFence);
	     },
	     //多边形
	     drawPolygon: function(polygon, thisMap){
	         var dataArr = new Array();
	         if (polygon != null && polygon.length > 0) {
	             for (var i = 0; i < polygon.length; i++) {
	                 dataArr.push([polygon[i].longitude, polygon[i].latitude]);
	             }
	         }
	         polyFence = new AMap.Polygon({
	             path: dataArr,//设置多边形边界路径
	             strokeColor: "#FF33FF", //线颜色
	             strokeOpacity: 0.2, //线透明度
	             strokeWeight: 3, //线宽
	             fillColor: "#1791fc", //填充色
	             fillOpacity: 0.35
	             //填充透明度
	         });
	         polyFence.setMap(thisMap);
	         thisMap.setFitView(polyFence);
	     },
	     //圆形
	     drawCircle: function(circle, thisMap){
	         polyFence = new AMap.Circle({
	             center: new AMap.LngLat(circle.longitude, circle.latitude),// 圆心位置
	             radius: circle.radius, //半径
	             strokeColor: "#F33", //线颜色
	             strokeOpacity: 1, //线透明度
	             strokeWeight: 3, //线粗细度
	             fillColor: "#ee2200", //填充颜色
	             fillOpacity: 0.35
	             //填充透明度
	         });
	         polyFence.setMap(thisMap);
	         thisMap.setFitView(polyFence);
	     },
	     //按围栏 树结构搜索
	     searchFenceSearch: function(){
   		 	search_ztree('fenceDemo', 'searchFence','fence');
	     },
	     searchVehicleSearch: function(){
	 		search_ztree('treeDemo', 'searchVehicle','vehicle');
	     },
	     searchFenceCarSearch: function(){
	     	search_ztree('fenceDemoCar', 'searchFenceCar','fence');
	     },
	   	 //监控对象
	     searchVehicleCarSearch: function(){
	     	search_ztree('treeDemoCar', 'searchVehicleCar','vehicle');
	     },
	     beforeClickVehicle: function(treeId, treeNode){
            var zTree = $.fn.zTree.getZTreeObj("treeDemo");
            zTree.checkNode(treeNode, !treeNode.checked, null, true);
            return false;
         },
         onCheckVehicle: function(e, treeId, treeNode){
            var zTree = $.fn.zTree.getZTreeObj("treeDemo"), nodes = zTree
                    .getCheckedNodes(true), v = "";
            for (var i = 0, l = nodes.length; i < l; i++) {
                v += nodes[i].name + ",";
            }
         },
         onClickFence: function(e, treeId, treeNode){
             var zTree = $.fn.zTree.getZTreeObj("fenceDemo");
             var nodes = zTree.getSelectedNodes(true);
 			if(treeNode.isParent == true){
 				zTree.cancelSelectedNode(nodes[0]);
 				return false;
             };
             $("#fenceMap").attr("class","fa fa-chevron-down mapBind");
         	$("#fenceMapArea").css("display","block");
             var nodesId = treeNode.id;
             //判断是否是第一次点击
             if(clickStateFence == undefined){
             	//msg(1);
             	clickStateFence = nodesId;
             	map.clearMap();
             	zTree.checkNode(nodes[0],true,true);
             	fenceBindingList.getFenceDetail(nodes, map);
             }else{
             	if(nodesId == clickStateFence){
             		if(fenceFlag){
             			//再次点击同一个节点时（选中状态）
             			zTree.checkNode(nodes[0],false,true);
             			zTree.cancelSelectedNode(nodes[0]);
                 		polyFence.setMap();
                 		fenceFlag = false;
             		}else{
             			//再次点击同一个节点时（取消状态）
             			map.clearMap();
             			zTree.checkNode(nodes[0],true,true);
             			fenceBindingList.getFenceDetail(nodes, map);
                     	fenceFlag = true;
             		}
             		clickStateFence = nodesId;
             	}else{
             		//点击其它节点
             		map.clearMap();
             		zTree.checkNode(nodes[0],true,true);
             		fenceBindingList.getFenceDetail(nodes, map);
                 	clickStateFence = nodesId;
                 	fenceFlag = true;
             	}
             }
         },
         onCheckFence: function(e, treeId, treeNode){
 		 },
 		 beforeClickVehicelChar: function(treeId, treeNode){
             var zTree = $.fn.zTree.getZTreeObj("treeDemoCar");
             zTree.checkNode(treeNode, !treeNode.checked, null, true);
             return false;
         },
         onCheckVehicleChar: function(e, treeId, treeNode){
             var zTree = $.fn.zTree.getZTreeObj("treeDemoCar"), nodes = zTree
                     .getCheckedNodes(true), v = "";
             for (var i = 0, l = nodes.length; i < l; i++) {
                 v += nodes[i].name + ",";
             }
         },
         onClickFenceChar: function(e, treeId, treeNode){
         	var zTree = $.fn.zTree.getZTreeObj("fenceDemoCar");
             var nodes = zTree.getSelectedNodes(true);
 			if(treeNode.isParent == true){
 				zTree.cancelSelectedNode(nodes[0]);
 				return false;
             };
             $("#charMap").attr("class","fa fa-chevron-down mapBind");
         	$("#charMapArea").css("display","block");
             var nodesId = treeNode.id;
             if(clickStateChar == undefined){
             	clickStateChar = nodesId;
             	mapCar.clearMap();
             	zTree.checkNode(nodes[0],true,true);
             	fenceBindingList.getFenceDetail(nodes, mapCar);
             }else{
             	if(nodesId == clickStateChar){
             		if(charFlag){
             			zTree.checkNode(nodes[0],false,true);
             			zTree.cancelSelectedNode(nodes[0]);
                 		polyFence.setMap();
                 		charFlag = false;
             		}else{
             			mapCar.clearMap();
             			zTree.checkNode(nodes[0],true,true);
             			fenceBindingList.getFenceDetail(nodes, mapCar);
                     	charFlag = true;
             		}
             		clickStateChar = nodesId;
             	}else{
             		zTree.checkNode(nodes[0],true,true);
             		mapCar.clearMap();
             		fenceBindingList.getFenceDetail(nodes, mapCar);
                 	clickStateChar = nodesId;
                 	charFlag = true;
             	}
             }
         },
         onCheckFenceChar: function(e, treeId, treeNode){
         },
         //check选择
         checkAllClick: function(){
	        if ($(this).prop("checked") === true) {
	            $("#checkAll").attr("checked", true);
	            $("#tableList input[type='checkbox']").prop("checked",
	                    $(this).prop("checked"));
	            $('#tableList tbody tr').addClass('selected');
	            for (i = 1; i <= $("#tableList tr").length; i++){
	            	trid.push("list"+i);
	            }
	        } else {
	            $("#checkAll").attr("checked", false);
	            $("#tableList input[type='checkbox']").prop("checked", false);
	            $('#tableList tbody tr').removeClass('selected');
	            trid = [];
	        }
         },
         checkCarAllClick: function(){
	        if ($(this).prop("checked") === true) {
	            $("#checkCarAll").attr("checked", true);
	            $("#tableListCar input[type='checkbox']").prop("checked",
	                    $(this).prop("checked"));
	            $('#tableListCar tbody tr').addClass('selected');
	            for (i = 1; i <= $("#tableListCar tr").length; i++){
	            	tridCar.push("listCar"+i);
	            }
	        } else {
	            $("#checkCarAll").attr("checked", false);
	            $("#tableListCar input[type='checkbox']").prop("checked", false);
	            $('#tableListCar tbody tr').removeClass('selected');
	            tridCar = [];
	        }
         },
         //当点击或选择围栏时，访问后台返回围栏详情
         getFenceDetail: function(fenceNode, showMap) {
             if (fenceNode == null || fenceNode.length == 0) {
                 // 清空地图上的图形
                 showMap.clearMap()
             } else {
                 // ajax访问后端查询
                 layer.load(2);
                 $.ajax({
                     type: "POST",
                     url: "getFenceDetail",
                     data: {
                         "fenceNodes": JSON.stringify(fenceNode)
                     },
                     dataType: "json",
                     success: function (data) {
                     	layer.closeAll('loading');
                         if (data.success) {
                             var dataList = data.obj;
                             if (dataList != null && dataList.length > 0) {
                                 for (var i = 0; i < dataList.length; i++) {
                                     var fenceType = dataList[i].fenceType;
                                     var fenceData = dataList[i].fenceData;
                                     if (fenceType == "zw_m_marker") { // 标注
                                     	fenceBindingList.drawMark(fenceData, showMap);
                                     } else if (fenceType == "zw_m_line") { // 线
                                     	fenceBindingList.drawLine(fenceData, showMap);
                                     } else if (fenceType == "zw_m_rectangle") { // 矩形
                                     	fenceBindingList.drawRectangle(fenceData, showMap);
                                     } else if (fenceType == "zw_m_polygon") { // 多边形
                                     	fenceBindingList.drawPolygon(fenceData, showMap);
                                     } else if (fenceType == "zw_m_circle") { // 圆形
                                     	fenceBindingList.drawCircle(fenceData, showMap);
                                     }
                                 }
                             }

                         }

                     }
                 });
             }
         },
         // 点击添加(按围栏 )
         addBtnClick: function(){
             // 动态添加表格
             fenceTree = $.fn.zTree.getZTreeObj("fenceDemo");
             vehicelTree = $.fn.zTree.getZTreeObj("treeDemo");
             fenceNode = fenceTree.getCheckedNodes();
             vehicleNode = vehicelTree.getCheckedNodes();
             if (fenceNode == null || vehicleNode == null
                     || fenceNode.length == 0
                     || vehicleNode.length == 0) {
                 layer.msg("至少选择一个围栏或车辆！",{move:false});
             } else {
                 var fenceName = fenceNode[0].name;
                 // 先清空table 中的数据
                 $("#tableList tbody").html("");
                 // 去重
                 vehicleNode = vehicleNode.unique2();
                 var j = 0;
                 for (var i = 0; i < vehicleNode.length; i++) {
                     if (vehicleNode[i].type == "vehicle") {
                         j++;
                         var inRadioName = "Inradio" + j;
                         var outRadioName = "Outradio" + j;
                         var sendFenceTypeName = "sendFenceType"+j;
                         var fencetype = fenceNode[0].pId;
                         var tr = "<tr id='list" + j + "'><td><input id='checkList" + j + "' type='checkbox' onclick='fenceBindingList.checkboxis(this)'   name='thead'/></td><td><a class='fenceName'>"
                                 + fenceName
                                 + "</a></td><td>"
                                 + vehicleNode[i].name
                                 + "</td><td>"
                                 + fenceBindingList.fencetypepid(fencetype)
                                 + "</td>"
                                 + fenceBindingList.sendFenceTypeTd(fencetype,sendFenceTypeName)
                                 + "<td id = 'alarmIn'><input type='radio' value = 1 checked name='" + inRadioName + "'>是<input type='radio' value = 0 name='" + inRadioName + "'>否</td>"
                                 + "<td id = 'alarmOut'><input type='radio'  value = 1 checked name='" + outRadioName + "'>是<input type='radio'  value = 0 name='" + outRadioName + "'>否</td>"
                                 + "<td id = 'startTime'><input style='width:120px;cursor:default;' class='form-control layer-date laydate-icon selectTime' name='startTime' onclick=\"laydate({istime: true, format: \'YYYY-MM-DD\'})\" readonly /></td>"
                                 + "<td id = 'endTime'><input style='width:120px;cursor:default;'  class='form-control layer-date laydate-icon selectTime' name='endTime' onclick=\"laydate({istime: true, format: \'YYYY-MM-DD\'})\" readonly /></td>"
                                 + "<td id = 'alarmStartDate'><input id='startTimeHMS"+ j +"' style='width:120px;cursor:default;'  class='form-control layer-date laydate-icon'  name='alarmStartDate' onclick=\"fenceBindingList.laydateTime(this)\" readonly /></td>"
                                 + "<td id = 'alarmEndDate'><input id='endTimeHMS"+ j +"'style='width:120px;cursor:default;'  class='form-control layer-date laydate-icon' name='alarmEndDate' onclick=\"fenceBindingList.laydateTime(this)\" readonly /></td>"
                                 + "<td id='speed'><input type= 'number' name = 'speed'/></td>"
                                 + "<td id='overSpeedLastTime'><input type= 'number' name = 'overSpeedLastTime'/></td>"
                                 + "<td class='hidden' id='fenceId'>"
                                 + fenceNode[0].fenceInfoId
                                 + "</td><td class='hidden' id = 'vehicleId'>"
                                 + vehicleNode[i].id + "</td></tr>";
                         $("#tableList tbody").append(tr);
                     }
                 }
    			 $(".fenceName").on("click",function(){
              		$("#fenceMap").attr("class","fa fa-chevron-down mapBind");
                  	$("#fenceMapArea").css("display","block");
                 	var fenceId = $(this).parent().siblings("#fenceId")[0].innerHTML;
                 	var treeObj = $.fn.zTree.getZTreeObj("fenceDemo");
                 	var nodesArray = [];
                 	var nodes = treeObj.getNodeByParam("fenceInfoId",fenceId, null);
                 	nodesArray.push(nodes);
                 	map.clearMap();
                 	fenceBindingList.getFenceDetail(nodesArray, map);
                 });
    			 $(".selectTime").on("click",function(){
    				$("#hmsTime").hide();
    			 });
           	  }
         },
         checkboxis: function(checkbox){
             $("#checkAll").attr("checked", false)
             if (checkbox.checked == true) {
                 trid.push($("#" + checkbox.id).parents("tr").attr("id"));
             } else {
                 trid = $.grep(trid, function (value, i) {
                     return value != $("#" + checkbox.id).parents("tr").attr("id");
                 });
                 return trid;
             }
         },
         checkboxisCar: function(checkbox){
             $("#checkCarAll").attr("checked", false)
             /* msg("11111"); */
             if (checkbox.checked == true) {
                 tridCar.push($("#" + checkbox.id).parents("tr").attr("id"));
             } else {
             	tridCar = $.grep(tridCar, function (value, i) {
                     return value != $("#" + checkbox.id).parents("tr").attr("id");
                 });
                 return tridCar;
             }
         },
       	 //点击解绑按围栏
         removeBtnClick: function(){
             if ($("#checkAll").attr("checked") == "checked") {
                 for (var k = 0; k <= vehicleNode.length; k++) {
                     trid.push($("#list" + k))
                     $("#list" + k).remove();
                 }
                 $("#checkAll").attr("checked", false)
             } else {
                 if (trid.length == 0) {
                     layer.msg("请您至少勾选一项",{move:false})
                 }
                 for (var i = 0; i < trid.length; i++) {
                     $("#" + trid[i]).remove();
                 }
             }
             trid = [];
         },
         //点击解绑按车
         removeBtnCarClick: function(){
             if ($("#checkCarAll").attr("checked") == "checked") {
                 for (var k = 0; k <= fenceNode.length; k++) {
                     tridCar.push($("#listCar" + k))
                     $("#listCar" + k).remove();
                 }
                 $("#checkCarAll").attr("checked", false)
             } else {
                 if (tridCar.length == 0) {
                     layer.msg("请您至少勾选一项",{move:false})
                 }
                 for (var i = 0; i <= tridCar.length; i++) {
                     $("#" + tridCar[i]).remove();
                 }
             }
             tridCar = [];
         },
         //依例全设
         setAllClick: function(){
             var i = 0;
             var setSendFenceType = '';
             var setalarmIn = '';
             var setalarmOut = '';
             var startTimeVal = '';
             var endTimeVal = '';
             var nameSendFenceType = '';
             var namein = '';
             var nameout = '';
             var startDateVal = '';
             var endDateVal = '';
             var speedVal = '';
             if (trid.length !== 1) {
                 layer.msg([[#{fence.select.item}]],{move:false})
             } else {
            	 if ($("#" + trid[0]).children("td").eq(4).id = "sendFenceType") {
            		 nameSendFenceType = $("#" + trid[0]).children("td").eq(4).find("input").attr("name")
                     setSendFenceType = $('input[name="' + nameSendFenceType + '"]:checked').val();
                 }
                 if ($("#" + trid[0]).children("td").eq(5).id = "alarmIn") {
                     namein = $("#" + trid[0]).children("td").eq(5).find("input").attr("name")
                     setalarmIn = $('input[name="' + namein + '"]:checked').val();
                 }
                 if ($("#" + trid[0]).children("td").eq(6).id = "alarmOut") {
                     nameout = $("#" + trid[0]).children("td").eq(6).find("input").attr("name")
                     setalarmOut = $('input[name="' + nameout + '"]:checked').val();
                 }
                 if ($("#" + trid[0]).children("td").eq(7).find("input").val() != null) {
                     startTimeVal = $("#" + trid[0]).children("td").eq(7).find("input").val();
                 }
                 if ($("#" + trid[0]).children("td").eq(8).find("input").val() != null) {
                     endTimeVal = $("#" + trid[0]).children("td").eq(8).find("input").val();
                 }
                 if ($("#" + trid[0]).children("td").eq(9).find("input").val() != null) {
                     startDateVal = $("#" + trid[0]).children("td").eq(9).find("input").val();
                 }
                 if ($("#" + trid[0]).children("td").eq(10).find("input").val() != null) {
                     endDateVal = $("#" + trid[0]).children("td").eq(10).find("input").val();
                 }
                 if ($("#" + trid[0]).children("td").eq(11).find("input").val() != null) {
                     speedVal = $("#" + trid[0]).children("td").eq(11).find("input").val();
                 }
                 if ($("#" + trid[0]).children("td").eq(12).find("input").val() != null) {
                 	overSpeedLastTimeVal = $("#" + trid[0]).children("td").eq(12).find("input").val();
                 }
                 for (i = 2; i <= $("#tableList tr").length; i++)
                     $("#tableList tr td").each(function () {
                         var td = this;
                         if (setSendFenceType == 0) {
                             $(td).find('input[name="sendFenceType' + i + '"][type="radio"]').eq(0).prop("checked", true);
                             $(td).find('input[name="sendFenceType' + i + '"][type="radio"]').eq(1).prop("checked", false)
                             $(td).find('input[name="sendFenceType' + i + '"][type="radio"]').eq(2).prop("checked", false)
                         } else if (setSendFenceType == 1) {
                        	 $(td).find('input[name="sendFenceType' + i + '"][type="radio"]').eq(0).prop("checked", false);
                             $(td).find('input[name="sendFenceType' + i + '"][type="radio"]').eq(1).prop("checked", true)
                             $(td).find('input[name="sendFenceType' + i + '"][type="radio"]').eq(2).prop("checked", false)
                         } else if (setSendFenceType == 2) {
                        	 $(td).find('input[name="sendFenceType' + i + '"][type="radio"]').eq(0).prop("checked", false);
                             $(td).find('input[name="sendFenceType' + i + '"][type="radio"]').eq(1).prop("checked", false)
                             $(td).find('input[name="sendFenceType' + i + '"][type="radio"]').eq(2).prop("checked", true)
                         }
                         if (setalarmIn == 1) {
                             $(td).find('input[name="Inradio' + i + '"][type="radio"]').eq(0).prop("checked", true);
                             $(td).find('input[name="Inradio' + i + '"][type="radio"]').eq(1).prop("checked", false)
                         } else if (setalarmIn == 0) {
                             $(td).find('input[name="Inradio' + i + '"][type="radio"]').eq(1).prop("checked", true);
                             $(td).find('input[name="Inradio' + i + '"][type="radio"]').eq(0).prop("checked", false)
                         }
                         if (setalarmOut == 1) {
                             $(td).find('input[name="Outradio' + i + '"][type="radio"]').eq(0).prop("checked", true);
                             $(td).find('input[name="Outradio' + i + '"][type="radio"]').eq(1).prop("checked", false)
                         } else if (setalarmOut == 0) {
                             $(td).find('input[name="Outradio' + i + '"][type="radio"]').eq(1).prop("checked", true);
                             $(td).find('input[name="Outradio' + i + '"][type="radio"]').eq(0).prop("checked", false)
                         }
                         if (startTimeVal != null) {
                             $(td).find('input[name="startTime"]').val(startTimeVal);
                         }
                         if (endTimeVal != null) {
                             $(td).find('input[name="endTime"]').val(endTimeVal);
                         }
                         if (startDateVal != null) {
                             $(td).find('input[name="alarmStartDate"]').val(startDateVal);
                         }
                         if (endDateVal != null) {
                             $(td).find('input[name="alarmEndDate"]').val(endDateVal);
                         }
                         if (speedVal != null) {
                             $(td).find('input[name="speed"]').val(speedVal);
                         }
                         if (overSpeedLastTimeVal != null) {
                             $(td).find('input[name="overSpeedLastTime"]').val(overSpeedLastTimeVal);
                         }
                     });
             }
         },
         //依例全设
         setAllCarClick: function(){
             var i = 0;
             var setSendFenceTypeCar = '';
             var setalarmInCar = '';
             var setalarmOutCar = '';
             var startTimeVal = '';  // 开始日期
             var endTimeVal = '';    // 结束日期
             var nameSendFenceTypeCar = '';
             var nameinCar = '';
             var nameoutCar = '';
             var startDateVal = '';  // 开始时间
             var endDateVal = '';    // 结束时间
             var speedVal = '';  // 限速
             if (tridCar.length !== 1) {
                 layer.msg([[#{fence.select.item}]],{move:false})
             } else {
            	 if ($("#" + trid[0]).children("td").eq(4).id = "sendFenceTypeCar") {
            		 nameSendFenceTypeCar = $("#" + trid[0]).children("td").eq(4).find("input").attr("name")
                     setSendFenceTypeCar = $('input[name="' + nameSendFenceTypeCar + '"]:checked').val();
                 }
                 if ($("#" + tridCar[0]).children("td")[5].id = "alarmInCar") {
                     nameinCar = $("#" + tridCar[0]).children("td").eq(5).find("input").attr("name")
                     setalarmInCar = $('input[name="' + nameinCar + '"]:checked').val();
                 }
                 if ($("#" + tridCar[0]).children("td")[6].id = "alarmOutCar") {
                     nameoutCar = $("#" + tridCar[0]).children("td").eq(6).find("input").attr("name")
                     setalarmOutCar = $('input[name="' + nameoutCar + '"]:checked').val();
                 }
                 if ($("#" + tridCar[0]).children("td").eq(7).find("input").val() != null) {
                     startTimeVal = $("#" + tridCar[0]).children("td").eq(7).find("input").val();
                 }
                 if ($("#" + tridCar[0]).children("td").eq(8).find("input").val() != null) {
                     endTimeVal = $("#" + tridCar[0]).children("td").eq(8).find("input").val();
                 }
                 if ($("#" + tridCar[0]).children("td").eq(9).find("input").val() != null) {
                     startDateVal = $("#" + tridCar[0]).children("td").eq(9).find("input").val();
                 }
                 if ($("#" + tridCar[0]).children("td").eq(10).find("input").val() != null) {
                     endDateVal = $("#" + tridCar[0]).children("td").eq(10).find("input").val();
                 }
                 if ($("#" + tridCar[0]).children("td").eq(11).find("input").val() != null) {
                     speedVal = $("#" + tridCar[0]).children("td").eq(11).find("input").val();
                 }
                 if ($("#" + tridCar[0]).children("td").eq(11).find("input").val() != null) {
                 	overSpeedLastTimeVal = $("#" + tridCar[0]).children("td").eq(11).find("input").val();
                 }
                 for (i = 2; i <= $("#tableListCar tr").length; i++)
                     $("#tableListCar tr td").each(function () {
                         var td = this;
                         if (setSendFenceTypeCar == 0) {
                             $(td).find('input[name="sendFenceTypeCar' + i + '"][type="radio"]').eq(0).prop("checked", true);
                             $(td).find('input[name="sendFenceTypeCar' + i + '"][type="radio"]').eq(1).prop("checked", false)
                             $(td).find('input[name="sendFenceTypeCar' + i + '"][type="radio"]').eq(2).prop("checked", false)
                         } else if (setSendFenceTypeCar == 1) {
                        	 $(td).find('input[name="sendFenceTypeCar' + i + '"][type="radio"]').eq(0).prop("checked", false);
                             $(td).find('input[name="sendFenceTypeCar' + i + '"][type="radio"]').eq(1).prop("checked", true)
                             $(td).find('input[name="sendFenceTypeCar' + i + '"][type="radio"]').eq(2).prop("checked", false)
                         } else if (setSendFenceTypeCar == 2) {
                        	 $(td).find('input[name="sendFenceTypeCar' + i + '"][type="radio"]').eq(0).prop("checked", false);
                             $(td).find('input[name="sendFenceTypeCar' + i + '"][type="radio"]').eq(1).prop("checked", false)
                             $(td).find('input[name="sendFenceTypeCar' + i + '"][type="radio"]').eq(2).prop("checked", true)
                         }
                         if (setalarmInCar == 1) {
                             $(td).find('input[name="inRadioName' + i + '"][type="radio"]').eq(0).prop("checked", true);
                             $(td).find('input[name="inRadioName' + i + '"][type="radio"]').eq(1).prop("checked", false)
                         } else if (setalarmInCar == 0) {
                             $(td).find('input[name="inRadioName' + i + '"][type="radio"]').eq(1).prop("checked", true);
                             $(td).find('input[name="inRadioName' + i + '"][type="radio"]').eq(0).prop("checked", false)
                         }
                         if (setalarmOutCar == 1) {
                             $(td).find('input[name="outRadioName' + i + '"][type="radio"]').eq(0).prop("checked", true);
                             $(td).find('input[name="outRadioName' + i + '"][type="radio"]').eq(1).prop("checked", false)
                         } else if (setalarmOutCar == 0) {
                             $(td).find('input[name="outRadioName' + i + '"][type="radio"]').eq(1).prop("checked", true);
                             $(td).find('input[name="outRadioName' + i + '"][type="radio"]').eq(0).prop("checked", false)
                         }
                         if (startTimeVal != null) {
                             $(td).find('input[name="startTimeCar"]').val(startTimeVal);
                         }
                         if (endTimeVal != null) {
                             $(td).find('input[name="endTimeCar"]').val(endTimeVal);
                         }
                         if (startDateVal != null) {
                             $(td).find('input[name="alarmStartDateCar"]').val(startDateVal);
                         }
                         if (endDateVal != null) {
                             $(td).find('input[name="alarmEndDateCar"]').val(endDateVal);
                         }
                         if (speedVal != null) {
                             $(td).find('input[name="speedCar"]').val(speedVal);
                         }
                         if (overSpeedLastTimeVal != null) {
                             $(td).find('input[name="overSpeedLastTimeCar"]').val(overSpeedLastTimeVal);
                         }
                     });
             }
         },
         offAllClick: function(){
             var i = 0;
             for (i = 1; i <= $("table tr").length; i++) {
                 $("table tr td").each(function () {
                     var td = this;
                     $(td).find('input[name="Inradio' + i + '"][type="radio"]').eq(0).prop("checked", true);
                     $(td).find('input[name="Outradio' + i + '"][type="radio"]').eq(0).prop("checked", true);
                     $(td).find('input[name="startTime"]').val("");
                     $(td).find('input[name="endTime"]').val("");
                 });
             }
         },
         offAllCarClick: function(){
             var i = 0;
             for (i = 1; i <= $("table tr").length; i++) {
                 $("table tr td").each(function () {
                     var td = this;
                     $(td).find('input[name="inRadioName' + i + '"][type="radio"]').eq(0).prop("checked", true);
                     $(td).find('input[name="outRadioName' + i + '"][type="radio"]').eq(0).prop("checked", true);
                     $(td).find('input[name="startTimeCar"]').val("");
                     $(td).find('input[name="endTimeCar"]').val("");
                 });
             }
         },
         //比较时间大小 a > b true
         compareDate: function(a,b){
         	var dateA = new Date(a);
         	var dateB = new Date( b);
         	if(isNaN(dateA) || isNaN(dateB)) {
         		return false;
         	}
         	if(dateA > dateB) {
         		return true;
         	}else{
         		return false;
         	}
         },
         // 提交(按围栏)
         fenceSaveBtnClick: function(){
             var arr = [];
             var errFlag = 1;
         	var errMsg = "";
             var i = 0;
             // 遍历表格，组装Json
             $("#tableList tr").each(function () {
                 var tr = this;
                 var obj = {};
                 $(tr).children("td").each(function () {
                     var td = this;
                     if (td.id == "fenceId") {
                         obj.fenceId = $(td).html();
                     } else if (td.id == "vehicleId") {
                         obj.vehicleId = $(td).html();
                     } else if (td.id == "sendFenceType") {
                         obj.sendFenceType = $(td).find("input[name='sendFenceType" + i + "']:checked ").attr("value");
                     } else if (td.id == "alarmIn") {
                         obj.alarmInPlatform = $(td).find("input[name='Inradio" + i + "']:checked ").attr("value");
                     } else if (td.id == "alarmOut") {
                         obj.alarmOutPlatform = $(td).find("input[name='Outradio" + i + "']:checked ").attr("value");
                     } else if (td.id == "startTime") {
                         obj.alarmStartTime = $(td).find("input").val();
                     } else if (td.id == "endTime") {
                         obj.alarmEndTime = $(td).find("input").val();
                     } else if (td.id == "alarmStartDate") {
                     	 var time = $(td).find("input").val();
                     	if (time != null && time != "") {
                     		 obj.alarmStartDate = "2016-01-01 " + time;
                     	}
                     } else if (td.id == "alarmEndDate") {
                     	var time = $(td).find("input").val();
                     	if (time != null && time != "") {
                     		 obj.alarmEndDate = "2016-01-01 " + time;
                     	}
                     } else if (td.id == "speed") {
                         obj.speed = $(td).find("input").val();
                     } else if (td.id == "overSpeedLastTime") {
                         obj.overSpeedLastTime = $(td).find("input").val();
                     }
                 });

                 // 开始时间和结束时间要么都有，要么都没有
                 if (obj.alarmStartTime != "" &&  obj.alarmEndTime == "") {
                 	errFlag = 0;
                 	errMsg += '第'+(i)+'条数据请选择结束时间！<br/>';
                 } else if (obj.alarmStartTime == "" &&  obj.alarmEndTime != "") {
                 	errFlag = 0;
                 	errMsg += '第'+(i)+'条数据请选择开始时间！<br/>';
                 }  else if (obj.alarmStartTime != "" &&  obj.alarmEndTime != ""){ // 结束日期必须大于开始日期
                 	if (fenceBindingList.compareDate(obj.alarmStartTime, obj.alarmEndTime)) {
                 		errFlag = 0;
                     	errMsg += '第'+(i)+'条数据结束日期必须大于开始日期！<br/>';
                 	}
                 }
                 if (obj.speed < 0 || obj.speed > 65535){ // 限速校验最大值最小值
                 	errFlag = 0;
                 	errMsg += '第'+(i)+'条数限速的最小值为0，最大值为65535！<br/>';
                 }
                 if (obj.overSpeedLastTime < 0 || obj.overSpeedLastTime > 65535){ // 超速持续时长校验最大值最小值
                 	errFlag = 0;
                 	errMsg += '第'+(i)+'条数超速持续时长的最小值为0，最大值为65535！<br/>';
                 }

                 if (!jQuery.isEmptyObject(obj)) {
                     arr.push(obj);
                 }
                 i++;
             });
             // ajax访问后端
             if (arr == null || arr.length == 0) {
                 layer.msg("请绑定围栏!",{move:false});
             } else if (errFlag == 0) {
             	layer.msg(errMsg);
             } else {
             	 var url="saveBindFence";
                  var parameter={"data": JSON.stringify(arr)};
                  json_ajax("POST",url,"json",true,parameter, fenceBindingList.saveBindCallback);
             }
         },
         //保存围栏绑定回调方法
         saveBindCallback: function(data){
         	if (data != null) {
         		if (data.success) {
         			if (data.obj.flag == 1){
         				layer.msg('围栏绑定成功！', {closeBtn: 0}, function () {
                             location.reload(); //执行的刷新语句
                             layer.close();
                         });
                 	}else if (data.obj.flag == 2){
                 		layer.msg(data.obj.errMsg,{move:false});
                 	}
         		}else{
         			layer.msg(data.msg,{move:false});
         		}
         	}
         },
         // 点击添加(按车)
         addBtnCarClick: function(){
             // 动态添加表格
             fenceTree = $.fn.zTree.getZTreeObj("fenceDemoCar");
             vehicelTree = $.fn.zTree.getZTreeObj("treeDemoCar");
             fenceNode = fenceTree.getCheckedNodes();
             vehicleNode = vehicelTree.getCheckedNodes();
             if (fenceNode == null || vehicleNode == null
                     || fenceNode.length == 0
                     || vehicleNode.length == 0) {
                 layer.msg("至少选择一个围栏或车辆！",{move:false});
             } else {
                 var fenceName = fenceNode[0].name;
                 // 先清空table 中的数据
                 $("#tableListCar tbody").html("");
                 // 去重
                 fenceNode = fenceNode.unique2();
                 var j = 0;
                 for (var i = 0; i < fenceNode.length; i++) {
                     if (fenceNode[i].type == "fence") {
                         j++;
                         var inRadioName = "inRadioName" + j;
                         var outRadioName = "outRadioName" + j;
                         var sendFenceTypeNameCar = "sendFenceTypeCar" + j;
                         var fencetype = fenceNode[i].pId;
                         var tr = "<tr id='listCar" + j + "'><td><input id='checkListCar" + j + "' type='checkbox' onclick='fenceBindingList.checkboxisCar(this)' type='checkbox' name='checkListCar'/></td><td><a class='charName'>"
                                 + /* fenceName */fenceNode[i].name
                                 + "</a></td><td>"
                                 + vehicleNode[0].name
                                 + "</td><td>"
                                 + fenceBindingList.fencetypepid(fencetype)
                                 + "</td>"
                                 +  + "<td id = 'sendFenceTypeCar'><input type='radio' value = 0 checked name='" + sendFenceTypeNameCar + "'>更新<input type='radio' value = 1 name='" + sendFenceTypeNameCar + "'>追加<input type='radio' value = 2 name='" + sendFenceTypeNameCar + "'>修改</td>"
                                 + "<td id = 'alarmInCar'><input type='radio' value = 1 checked name='" + inRadioName + "'>是<input type='radio' value = 0 name='" + inRadioName + "'>否</td>"
                                 + "<td id = 'alarmOutCar'><input type='radio'  value = 1 checked name='" + outRadioName + "'>是<input type='radio'  value = 0 name='" + outRadioName + "'>否</td>"
                                 + "<td id = 'startTimeCar'><input style='width:120px;cursor:default;'  class='form-control layer-date laydate-icon selectTime' name='startTimeCar' onclick=\"laydate({istime: true, format: \'YYYY-MM-DD\'})\" readonly /></td>"
                                 + "<td id = 'endTimeCar'><input style='width:120px;cursor:default;'  class='form-control layer-date laydate-icon selectTime' name='endTimeCar' onclick=\"laydate({istime: true, format: \'YYYY-MM-DD\'})\" readonly /></td>"
                                 + "<td id = 'alarmStartDateCar'><input id='startTimeHMSS" + j + "' style='width:120px;cursor:default;'  class='form-control layer-date laydate-icon' name='alarmStartDateCar' onclick=\"fenceBindingList.laydateTime(this)\" readonly /></td>"
                                 + "<td id = 'alarmEndDateCar'><input id='endTimeHMSS"+ j +"' style='width:120px;cursor:default;'  class='form-control layer-date laydate-icon' name='alarmEndDateCar' onclick=\"fenceBindingList.laydateTime(this)\" readonly /></td>"
                                 + "<td id='speedCar'><input type= 'number' name = 'speedCar'/></td>"
                                 + "<td id='overSpeedLastTimeCar'><input type= 'number' name = 'overSpeedLastTimeCar'/></td>"
                                 + "<td class='hidden' id='fenceIdCar'>"
                                 + fenceNode[i].fenceInfoId
                                 + "</td><td class='hidden' id = 'vehicleIdCar'>"
                                 + vehicleNode[0].id + "</td></tr>";
                         $("#tableListCar tbody").append(tr);
                     }
                 }
                 $(".charName").on("click",function(){
                 	$("#charMap").attr("class","fa fa-chevron-down mapBind");
                 	$("#charMapArea").css("display","block");
                 	var fenceId = $(this).parent().siblings("#fenceIdCar")[0].innerHTML;
                 	var treeObj = $.fn.zTree.getZTreeObj("fenceDemoCar");
                 	var nodesArray = [];
                 	var nodes = treeObj.getNodeByParam("fenceInfoId",fenceId, null);
                 	nodesArray.push(nodes);
                 	mapCar.clearMap();
                 	fenceBindingList.getFenceDetail(nodesArray, mapCar);
                 });

                 $(".selectTime").on("click",function(){
          			$("#hmsTime").hide();
          		});
             }
         },
         fencetypepid: function(fencetype){
             if (fencetype == "zw_m_marker") {
                 return "标注";
             } else if (fencetype == "zw_m_line") {
                 return "线";
             } else if (fencetype == "zw_m_rectangle") {
                 return "矩形";
             } else if (fencetype == "zw_m_circle") {
                 return "圆形";
             } else if (fencetype == "zw_m_polygon") {
                 return "多边形";
             }
         },
         // 提交（按车）
         carSaveBtnClick: function(){
             var arr = [];
             var errFlag = 1;
             var errMsg = "";
             var i = 0;
             // 遍历表格，组装Json
             $("#bindTableByCar tr").each(function () {
                 var tr = this;
                 var obj = {};
                 $(tr).children("td").each(function () {
                     var td = this;
                     if (td.id == "fenceIdCar") {
                         obj.fenceId = $(td).html();
                     } else if (td.id == "vehicleIdCar") {
                         obj.vehicleId = $(td).html();
                     } else if (td.id == "sendFenceTypeCar") {
                         obj.sendFenceType = $(td).find("input[name='sendFenceTypeCar" + i + "']:checked ").attr("value");
                     } else if (td.id == "alarmInCar") {
                         obj.alarmIn = $(td).find("input[name='inRadioName" + i + "']:checked ").attr("value");
                     } else if (td.id == "alarmOutCar") {
                         obj.alarmOut = $(td).find("input[name='outRadioName" + i + "']:checked ").attr("value");
                     } else if (td.id == "startTimeCar") {
                         obj.alarmStartTime = $(td).find("input").val();
                     } else if (td.id == "endTimeCar") {
                         obj.alarmEndTime = $(td).find("input").val();
                     } else if (td.id == "alarmStartDateCar") {
                     	var time = $(td).find("input").val();
                     	if (time != null && time != "") {
                     		 obj.alarmStartDate = "2016-01-01 " + time;
                     	}
                     } else if (td.id == "alarmEndDateCar") {
                     	var time = $(td).find("input").val();
                     	if (time != null && time != "") {
                     		 obj.alarmEndDate = "2016-01-01 " + time;
                     	}
                     } else if (td.id == "speedCar") {
                         obj.speed = $(td).find("input").val();
                     }else if (td.id == "overSpeedLastTimeValCar") {
                     	obj.overSpeedLastTime = $(td).find("input").val();
                		}
                 });
              	// 开始时间和结束时间要么都有，要么都没有
                 if (obj.alarmStartTime != "" &&  obj.alarmEndTime == "") {
                 	errFlag = 0;
                 	errMsg += '第'+(i)+'条数据请选择结束时间！<br/>';
                 } else if (obj.alarmStartTime == "" &&  obj.alarmEndTime != "") {
                 	errFlag = 0;
                 	errMsg += '第'+(i)+'条数据请选择开始时间！<br/>';
                 } else if (obj.alarmStartTime != "" &&  obj.alarmEndTime != ""){ // 结束日期必须大于开始日期
                 	if (fenceBindingList.compareDate(obj.alarmStartTime, obj.alarmEndTime)) {
                 		errFlag = 0;
                     	errMsg += '第'+(i)+'条数据结束日期必须大于开始日期！<br/>';
                 	}
                 }
                 if (obj.speed < 0 || obj.speed > 65535){ // 限速校验最大值最小值
                 	errFlag = 0;
                 	errMsg += '第'+(i)+'条数限速的最小值为0，最大值为65535！<br/>';
                 }
                 if (obj.overSpeedLastTime < 0 || obj.overSpeedLastTime > 65535){ // 限速校验最大值最小值
                 	errFlag = 0;
                 	errMsg += '第'+(i)+'条数超速持续时长的最小值为0，最大值为65535！<br/>';
                 }
                 if (!jQuery.isEmptyObject(obj)) {
                     arr.push(obj);
                 }
                 i++;
             });
             // ajax访问后端
             if (arr == null || arr.length == 0) {
                 layer.msg("请绑定围栏!",{move:false});
             } else if (errFlag == 0) {
             	layer.msg(errMsg);
             } else {
             	 var url="saveBindFence";
                  var parameter={"data": JSON.stringify(arr)};
                  json_ajax("POST",url,"json",true,parameter, fenceBindingList.saveBindCallback);
             }
         },
         //全选
         tableCheckAllClick: function(){
             $("input[name='subChk']").prop("checked", this.checked);
         },
         //单选
         subChkClick: function(){
             $("#tableCheckAll").prop(
                     "checked",
                     subChk.length == subChk.filter(":checked").length ? true
                             : false);
         },
         // 下发围栏 （单个）
         sendFenceOne: function(id,paramId,vehicleId,fenceId){
         	 var arr = [];
         	 var obj = {};
              obj.fenceConfigId = id;
              obj.paramId = paramId;
              obj.vehicleId = vehicleId;
              obj.fenceId=fenceId
              arr.push(obj);
              var jsonStr = JSON.stringify(arr);
              fenceBindingList.sendFence(jsonStr);
         },
         // 下发围栏
     	 sendFence: function(sendParam){
     		  var url="/clbs/m/functionconfig/fence/bindfence/sendFence";
              var parameter={"sendParam": sendParam};
              json_ajax("POST",url,"json",true,parameter, fenceBindingList.sendFenceCallback);
     	 },
         // 围栏下发回调
         sendFenceCallback: function(data){
     	     if(sendflag){
                 webSocket.subscribe(headers,'/topic/fencestatus', fenceBindingList.updataFenceData,null, null);
                 sendflag=false;
             }
             layer.msg([[#{send.command.complete}]], {closeBtn: 0}, function(refresh){
                 //取消全选勾
                 $("#checkAll").prop('checked',false);
                 $("input[name=subChk]").prop("checked",false);
                 myTable.refresh(); //执行的刷新语句
        		 layer.close(refresh);
        		});
         },
         //批量删除
         delModelClick: function(){
             //判断是否至少选择一项
             var chechedNum = $("input[name='subChk']:checked").length;
             if (chechedNum == 0) {
                 layer.msg([[#{select.item}]]);
                 return
             }
             var checkedList = new Array();
             $("input[name='subChk']:checked").each(function () {
             	var jsonStr = $(this).val();
             	var jsonObj = $.parseJSON(jsonStr);
                 checkedList.push(jsonObj.fenceConfigId);
             });
             myTable.deleteItems({
                 'deltems': checkedList.toString()
             });
       	 },
         // 批量下发
       	 sendModelClick: function(){
             //判断是否至少选择一项
             var chechedNum = $("input[name='subChk']:checked").length;
             if (chechedNum == 0) {
                 layer.msg([[#{select.item}]]);
                 return
             }
             var checkedList = new Array();
             $("input[name='subChk']:checked").each(function() {
             	var jsonStr = $(this).val();
             	var jsonObj = $.parseJSON(jsonStr);
                 checkedList.push(jsonObj);
             });
             // 下发
             fenceBindingList.sendFence(JSON.stringify(checkedList));
       	 },
         //数据表格围栏显示
         tableFence: function(id){
         	if($("#profile1").hasClass("active")){
         		$("#charMap").attr("class","fa fa-chevron-down mapBind");
             	$("#charMapArea").css("display","block");
             	var treeObj = $.fn.zTree.getZTreeObj("fenceDemoCar");
             	var nodesArray = [];
             	var nodes = treeObj.getNodeByParam("id",id, null);
             	nodesArray.push(nodes);
             	mapCar.clearMap();
             	fenceBindingList.getFenceDetail(nodesArray, mapCar);
         	}else{
         		$("#fenceMap").attr("class","fa fa-chevron-down mapBind");
              	$("#fenceMapArea").css("display","block");
             	var treeObj = $.fn.zTree.getZTreeObj("fenceDemo");
             	var nodesArray = [];
             	var nodes = treeObj.getNodeByParam("id",id, null);
             	nodesArray.push(nodes);
             	map.clearMap();
             	fenceBindingList.getFenceDetail(nodesArray, map);
         	}
         },
       	 //卫星地图及地图切换
         setMapClick: function(){
             if(isMapThreeDFlag){
                 $("#setMap").addClass("map-active");
                 buildings.setMap(null);
                 satellLayer.show();
                 isMapThreeDFlag = false;
             }else{
                 $("#setMap").removeClass("map-active");
                 buildings.setMap(map);
                 satellLayer.hide();
                 isMapThreeDFlag = true;
             }
         },
         setMapCarClick: function(){
             if(isMapThreeDFlagCar){
                 $("#setMapCar").addClass("map-active");
                 buildings.setMap(null);
                 satellLayerCar.show();
                 isMapThreeDFlagCar = false;
             }else{
                 $("#setMapCar").removeClass("map-active");
                 buildings.setMap(map);
                 satellLayerCar.hide();
                 isMapThreeDFlagCar = true;
             }
         },
         //刷新列表
         refreshTableClick: function(){
         	$('#simpleQueryParam').val("");
         	myTable.filter();
         },
         //切换围栏Map
         TabCarBoxClick: function(){
         	mapCar.clearMap();
            $("#mapContainerBox").hide();
            Carbox.show();
         },
         TabFenceBoxClick: function(){
        	map.clearMap();
            $("#mapContainerBox").show();
            Carbox.hide();
         },
         checkTime: function(cur){
       		var reg=/^((20|21|22|23|[0-1]\d)\:[0-5][0-9]\:[0-5][0-9])?$/;
     	 	if(!reg.test(cur)){
             	return false;
            }
     	 	return true;
         },
      	 // 显示错误提示信息
         showErrorMsg: function(msg, inputId){
         	if ($("#error_label").is(":hidden")) {
     			$("#error_label").text(msg);
     			$("#error_label").insertAfter($("#" + inputId));
     	        $("#error_label").show();
     		} else {
     			$("#error_label").is(":hidden");
     		}
         },
         hideErrorMsg: function(){
         	$("#error_label").hide();
         },
         sendFenceTypeTd : function (fencetype,sendFenceTypeName) {
        	 if (fencetype != "zw_m_line" && fencetype !="zw_m_polygon" ){
        		 return  "<td id = 'sendFenceType'><input type='radio' value = 0 checked name='" + sendFenceTypeName + "'>更新<input type='radio' value = 1 name='" + sendFenceTypeName + "'>追加<input type='radio' value = 2 name='" + sendFenceTypeName + "'>修改</td>";
        	 }else{
        		 return  "<td id = 'sendFenceType'><input type='radio' disabled value = 0 checked name='" + sendFenceTypeName + "'>更新<input disabled type='radio' value = 1 name='" + sendFenceTypeName + "'>追加<input disabled type='radio' value = 2 name='" + sendFenceTypeName + "'>修改</td>"
        	 }
         },

	}

	$(function(){

		fenceBindingList.init();
		//addToolBars
		window.onload = function() {
			map.plugin(["AMap.ToolBar"], function() {
				map.addControl(new AMap.ToolBar());
			});
			if(location.href.indexOf('&guide=1')!==-1){
				map.setStatus({scrollWheel:false})
			}
		}
		$("#hourseSelect tr td").bind("click",fenceBindingList.hourseSelectClick);
		$("#minuteSelect tr td").bind("click",fenceBindingList.minuteSelectClick);
		$("#secondSelect tr td").bind("click",fenceBindingList.secondSelectClick);
		$("body").bind("click",fenceBindingList.bodyClickEvent);
		//地图初始隐藏
		$(".mapBind").bind("click",fenceBindingList.mapBindClick);
		//按围栏 树结构搜索
		$("#searchFence").bind('input oninput',fenceBindingList.searchFenceSearch);
 	  	$("#searchVehicle").bind('input oninput',fenceBindingList.searchVehicleSearch);
 		// 按监控对象  树结构搜索
 	  	$("#searchFenceCar").bind('input oninput',fenceBindingList.searchFenceCarSearch);
 	 	//监控对象
 	  	$("#searchVehicleCar").bind('input oninput',fenceBindingList.searchVehicleCarSearch);
        //check选择
        $("#checkAll").bind( "click",fenceBindingList.checkAllClick);
        $("#checkCarAll").bind("click",fenceBindingList.checkCarAllClick);
        // 点击添加(按围栏 )
        $("#addBtn").bind("click",fenceBindingList.addBtnClick);
        //点击解绑按围栏
        $("#removeBtn").bind("click",fenceBindingList.removeBtnClick);
        //点击解绑按车
        $("#removeBtnCar").bind("click",fenceBindingList.removeBtnCarClick);
        //依例全设
        $("#setAll").bind("click",fenceBindingList.setAllClick);
        //依例全设
        $("#setAllCar").bind("click",fenceBindingList.setAllCarClick);
        $("#offAll").bind("click",fenceBindingList.offAllClick);
        $("#offAllCar").bind("click",fenceBindingList.offAllCarClick);
        // 提交(按围栏)
        $("#fenceSaveBtn").bind("click",fenceBindingList.fenceSaveBtnClick);
        // 点击添加(按车)
        $("#addBtnCar").bind("click",fenceBindingList.addBtnCarClick);
        // 提交（按车）
        $("#carSaveBtn").bind("click",fenceBindingList.carSaveBtnClick);
        //全选
        $("#tableCheckAll").bind("click",fenceBindingList.tableCheckAllClick);
        //单选
        subChk.bind("click",fenceBindingList.subChkClick);
        //批量删除
        $("#del_model").bind("click",fenceBindingList.delModelClick);
        // 批量下发
        $("#send_model").bind("click",fenceBindingList.sendModelClick);
      	//卫星地图及地图切换
        $("#setMap").bind("click",fenceBindingList.setMapClick);
        $("#setMapCar").bind("click",fenceBindingList.setMapCarClick);
        //刷新
        $("#refreshTable").bind("click",fenceBindingList.refreshTableClick);
        //切换围栏Map
        $('#TabCarBox').bind("click",fenceBindingList.TabCarBoxClick);
        $('#TabFenceBox').bind("click",fenceBindingList.TabFenceBoxClick);

	})

})(window,$)
</script>
</html>
